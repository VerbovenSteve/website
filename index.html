<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI CRUD Operations</title>
    <script defer src="https://unpkg.com/alpinejs@2.8.2/dist/alpine.min.js"></script>
</head>
<body x-data="{
    films: null,
    newFilmTitle: '',
    selectedFilmId: null,
    updatedFilmTitle: ''
}">
    <div>
        <h1>Films</h1>

        <div x-show="films === null">Loading films...</div>

        <template x-if="films !== null">
            <div x-for="film in films" :key="film.film_id">
                <h2 x-text="film.title"></h2>
                <p>Release Year: <span x-text="film.release_year"></span></p>

                <button x-on:click="editFilm(film.film_id)">Edit</button>
                <button x-on:click="deleteFilm(film.film_id)">Delete</button>

                <div x-show="selectedFilmId === film.film_id">
                    <input type="text" x-model="updatedFilmTitle">
                    <button x-on:click="updateFilm(film.film_id)">Update</button>
                </div>
            </div>
        </template>

        <div>
            <h2>Create New Film</h2>
            <input type="text" x-model="newFilmTitle">
            <button x-on:click="createFilm">Create</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('https://star-wars-api-verbovensteve.cloud.okteto.net/films/all_with_characters_starships')
                .then(response => response.json())
                .then(data => {
                    Alpine.data['x-data'].films = data;
                });
        });

        Alpine.data['x-data'].createFilm = function () {
            const newFilmTitle = this.newFilmTitle.trim();

            if (newFilmTitle !== '') {
                fetch('https://star-wars-api-verbovensteve.cloud.okteto.net/films', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title: newFilmTitle }),
                })
                .then(response => response.json())
                .then(data => {
                    this.films.push(data);
                    this.newFilmTitle = '';
                });
            }
        };

        Alpine.data['x-data'].editFilm = function (filmId) {
            this.selectedFilmId = filmId;
            const film = this.films.find(f => f.film_id === filmId);
            this.updatedFilmTitle = film.title;
        };

        Alpine.data['x-data'].updateFilm = function (filmId) {
            const updatedFilmTitle = this.updatedFilmTitle.trim();

            if (updatedFilmTitle !== '') {
                fetch(`https://star-wars-api-verbovensteve.cloud.okteto.net/films/${filmId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ title: updatedFilmTitle }),
                })
                .then(() => {
                    const filmIndex = this.films.findIndex(f => f.film_id === filmId);
                    this.films[filmIndex].title = updatedFilmTitle;
                    this.selectedFilmId = null;
                });
            }
        };

        Alpine.data['x-data'].deleteFilm = function (filmId) {
            const confirmDelete = confirm('Are you sure you want to delete this film?');

            if (confirmDelete) {
                fetch(`https://star-wars-api-verbovensteve.cloud.okteto.net/films/${filmId}`, {
                    method: 'DELETE',
                })
                .then(() => {
                    this.films = this.films.filter(f => f.film_id !== filmId);
                });
            }
        };
    </script>
</body>
</html>
